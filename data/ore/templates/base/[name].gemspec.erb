# encoding: utf-8

require 'yaml'

Gem::Specification.new do |gemspec|
  files = if File.directory?('.git')
            `git ls-files`.split($/)
          elsif File.directory?('.hg')
            `hg manifest`.split($/)
          elsif File.directory?('.svn')
            `svn ls -R`.split($/).select { |path| File.file?(path) }
          else
            Dir['{**/}{.*,*}'].select { |path| File.file?(path) }
          end

  filter_files = lambda { |paths|
    case paths
    when Array
      (files & paths)
    when String
      (files & Dir[paths])
    end
  }

  version = {
    :file => 'lib/<%= @namespace_dir %>/version.rb',
    :constant => '<%= @namespace %>::VERSION'
  }

  defaults = {
    'name' => File.basename(File.dirname(__FILE__)),
    'files' => files,
    'executables' => filter_files['bin/*'].map { |path| File.basename(path) },
    'test_files' => filter_files['{test/{**/}*_test.rb,spec/{**/}*_spec.rb}'],
    'extra_doc_files' => filter_files['*.{txt,rdoc,md,markdown,tt,textile}'],
  }

  metadata = defaults.merge(YAML.load_file('gemspec.yml'))

  gemspec.name = metadata.fetch('name',defaults[:name])
  gemspec.version = if metadata['version']
                      metadata['version']
                    elsif File.file?('VERSION')
                      File.read('VERSION').chomp
                    elsif File.file?(defaults[:version][:file])
                      require File.join('.',defaults[:version][:file])
                      eval(defaults[:version][:constant])
                    end

  gemspec.summary = metadata.fetch('summary',metadata['description'])
  gemspec.description = metadata.fetch('description',metadata['summary'])
  gemspec.licenses = metadata['license']

  gemspec.authors = metadata['authors']
  gemspec.email = metadata['email']
  gemspec.homepage = metadata['homepage']

  case metadata['require_paths']
  when Array
    gemspec.require_paths = metadata['require_paths']
  when String
    gemspec.require_path = metadata['require_paths']
  end

  gemspec.files = filter_files[metadata['files']]

  gemspec.executables = metadata['executables']

  if Gem::VERSION < '1.7.'
    gemspec.default_executable = gemspec.executables.first
  end

  gemspec.test_files = filter_files[metadata['test_files']]

  unless gemspec.files.include?('.document')
    gemspec.extra_rdoc_files = metadata['extra_doc_files']
  end

  gemspec.post_install_message = metadata['post_install_message']
  gemspec.requirements = metadata['requirements']

  if gemspec.respond_to?(:required_ruby_version=)
    gemspec.required_ruby_version = metadata['required_ruby_version']
  end

  if gemspec.respond_to?(:required_rubygems_version=)
    gemspec.required_rubygems_version = metadata['required_ruby_version']
  end

  add_dependencies = lambda { |group|
    key = if group == :default
            'dependencies'
          else
            "#{group}_dependencies"
          end

    method = if group == :default
               'add_dependency'
             elsif gemspec.respond_to?("add_#{group}_dependency")
               "add_#{group}_dependency"
             else
               'add_dependency'
             end

    if metadata.has_key?(key)
      metadata[key].each do |name,versions|
        versions = case versions
                   when Array
                     versions.map { |v| v.to_s }
                   when String
                     versions.split(/,\s*/)
                   end

        gemspec.send(method,name.to_s,*versions)
      end
    end
  }

  add_dependencies[:default]
  add_dependencies['runtime']
  add_dependencies['development']
end
